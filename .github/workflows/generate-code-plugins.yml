name: Generowanie wtyczek VS Code
on:
  workflow_dispatch:
    inputs:
      vault_path:
        description: 'Ścieżka do vaulta (opcjonalnie). Jeśli pusta, użyty będzie katalog główny repo'
        required: false
        default: ''
      embed:
        description: 'Czy wstawić wynik bezpośrednio do pliku docs (--embed)'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  generate:
    name: Generuj listę wtyczek VS Code
    runs-on: ubuntu-latest
    steps:
      - name: Pobierz repozytorium
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ustaw uprawnienia skryptów
        run: chmod +x ./scripts/list_code_plugins.sh || true

      - name: Uruchom generator
        id: gen
        run: |
          VAULT_INPUT="${{ github.event.inputs.vault_path }}"
          EMBED_INPUT="${{ github.event.inputs.embed }}"
          if [[ -z "$VAULT_INPUT" ]]; then
            # jeśli nie podano vault_path, użyj katalogu głównego repo
            ./scripts/list_code_plugins.sh "$PWD" $( [[ "$EMBED_INPUT" == "true" ]] && echo "--embed" || echo "" )
          else
            ./scripts/list_code_plugins.sh "$VAULT_INPUT" $( [[ "$EMBED_INPUT" == "true" ]] && echo "--embed" || echo "" )
          fi

      - name: Zatwierdź i wyślij zmiany jeśli zaszły
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git status --porcelain | grep -q .; then
            git add docs/software/code/plugins/code_plugins_installed.md || true
            git commit -m "chore(docs): aktualizacja listy wtyczek (automatycznie)" || true
            git push || true
            echo "Zatwierdzono i wysłano zmiany."
          else
            echo "Brak zmian do zatwierdzenia."
          fi
