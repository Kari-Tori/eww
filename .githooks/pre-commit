#!/usr/bin/env bash
# Pre-commit hook: dzieli duże commity na porcje po max 18 plików
# Zapobiega problemom z Obsidian Graph (limit 255/20 nodes)
set -euo pipefail

readonly MAX_FILES=18
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Pobierz listę staged plików
mapfile -t STAGED_FILES < <(git diff --cached --name-only --diff-filter=ACM)
TOTAL_FILES=${#STAGED_FILES[@]}

echo -e "${BLUE}[EWW Git Hook]${NC} Wykryto ${TOTAL_FILES} plików staged..."

# Jeśli mało plików - normalny commit
if [[ $TOTAL_FILES -le $MAX_FILES ]]; then
    echo -e "${GREEN}✓${NC} OK - ${TOTAL_FILES} ≤ ${MAX_FILES}, kontynuuję commit"
    exit 0
fi

# Podziel na chunki
echo -e "${YELLOW}⚠${NC}  Więcej niż ${MAX_FILES} plików - dzielę na porcje..."

# Oblicz ile chunków potrzeba
NUM_CHUNKS=$(( (TOTAL_FILES + MAX_FILES - 1) / MAX_FILES ))
FILES_PER_CHUNK=$(( (TOTAL_FILES + NUM_CHUNKS - 1) / NUM_CHUNKS ))

echo -e "${BLUE}→${NC} ${TOTAL_FILES} plików → ${NUM_CHUNKS} commitów po ~${FILES_PER_CHUNK} plików"

# Unstage wszystko
git reset HEAD --quiet

# Commit w chunkach
for ((i=0; i<NUM_CHUNKS; i++)); do
    START=$((i * FILES_PER_CHUNK))
    END=$((START + FILES_PER_CHUNK))
    
    # Wybierz pliki dla tego chunka
    CHUNK_FILES=("${STAGED_FILES[@]:$START:$FILES_PER_CHUNK}")
    CHUNK_SIZE=${#CHUNK_FILES[@]}
    
    # Stage tylko te pliki
    git add "${CHUNK_FILES[@]}"
    
    # Automatyczny commit message
    COMMIT_MSG="auto: chunk $((i+1))/${NUM_CHUNKS} (${CHUNK_SIZE} plików)"
    
    echo -e "${BLUE}→${NC} Commit $((i+1))/${NUM_CHUNKS}: ${CHUNK_SIZE} plików..."
    git commit -m "$COMMIT_MSG" --no-verify --quiet
done

echo -e "${GREEN}✓${NC} Gotowe! Utworzono ${NUM_CHUNKS} commitów."
echo -e "${YELLOW}ℹ${NC}  Możesz zrobić 'git rebase -i' aby połączyć commity później."

# Anuluj oryginalny commit (już podzieliliśmy)
exit 1
