#!/usr/bin/env bash
# eww-index - Generuje INDEX.md z opisami folder√≥w i plik√≥w
set -euo pipefail

readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
readonly FILEDESC="${SCRIPT_DIR}/.filedesc"
readonly OUTPUT="${SCRIPT_DIR}/INDEX.md"

readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly YELLOW='\033[1;33m'
readonly NC='\033[0m'

# Za≈Çaduj opisy z .filedesc
declare -A DESCS

load_descriptions() {
    if [[ ! -f "$FILEDESC" ]]; then
        echo -e "${YELLOW}[WARN]${NC} Brak pliku .filedesc"
        return 1
    fi
    
    while IFS='|' read -r path desc; do
        [[ -z "$path" || "$path" =~ ^[[:space:]]*# ]] && continue
        
        path="${path#"${path%%[![:space:]]*}"}"
        path="${path%"${path##*[![:space:]]}"}"
        desc="${desc#"${desc%%[![:space:]]*}"}"
        desc="${desc%"${desc##*[![:space:]]}"}"
        
        DESCS["$path"]="$desc"
    done < "$FILEDESC"
    
    echo -e "${GREEN}[INFO]${NC} Za≈Çadowano ${#DESCS[@]} opis√≥w"
}

# Pobierz opis z .filedesc
get_desc() {
    local path="$1"
    echo "${DESCS[$path]:-}"
}

# Pobierz pierwszy nag≈Ç√≥wek z README.md folderu
get_folder_note() {
    local folder="$1"
    local readme="${SCRIPT_DIR}/${folder}/README.md"
    
    if [[ -f "$readme" ]]; then
        # Pobierz pierwszƒÖ liniƒô z opisem (po nag≈Ç√≥wku #)
        grep -m 1 "^[^#]" "$readme" | sed 's/^[[:space:]]*//' || echo ""
    else
        echo ""
    fi
}

# Generuj INDEX.md
generate_index() {
    cat > "$OUTPUT" <<'HEADER'
# INDEX - E-Waste Workshop

> **Automatycznie wygenerowany indeks repozytorium**  
> Ostatnia aktualizacja: 2025-11-09

## üìñ O tym dokumencie

Ten plik zawiera kompletny indeks wszystkich folder√≥w i plik√≥w w projekcie wraz z ich opisami.

- **Foldery** - opis z ich `README.md` lub `.filedesc`
- **Pliki** - opis z `.filedesc`

---

HEADER

    # === FOLDERY G≈Å√ìWNE ===
    cat >> "$OUTPUT" <<'SECTION'
## üìÅ Struktura g≈Ç√≥wna

| Folder | Opis |
|--------|------|
SECTION

    for folder in lib dev docs archive; do
        local desc
        desc=$(get_desc "${folder}/")
        
        if [[ -z "$desc" ]]; then
            desc=$(get_folder_note "$folder")
        fi
        
        echo "| \`$folder/\` | ${desc:-Brak opisu} |" >> "$OUTPUT"
    done
    
    echo "" >> "$OUTPUT"
    
    # === PLIKI G≈Å√ìWNE ===
    cat >> "$OUTPUT" <<'SECTION'
## üìÑ Pliki g≈Ç√≥wne (MVP)

| Plik | Opis |
|------|------|
SECTION

    for file in README.md VERSION CHANGELOG.md Makefile MVP.md AGENTS.md init-eww.sh .filedesc; do
        if [[ -f "${SCRIPT_DIR}/$file" ]]; then
            local desc
            desc=$(get_desc "$file")
            echo "| \`$file\` | ${desc:-Brak opisu} |" >> "$OUTPUT"
        fi
    done
    
    echo "" >> "$OUTPUT"
    
    # === LIB/ ===
    cat >> "$OUTPUT" <<'SECTION'
## üìñ lib/ - Biblioteki wsp√≥≈Çdzielone

SECTION

    local lib_desc
    lib_desc=$(get_desc "lib/")
    [[ -n "$lib_desc" ]] && echo "> **$lib_desc**" >> "$OUTPUT"
    
    local lib_note
    lib_note=$(get_folder_note "lib")
    [[ -n "$lib_note" ]] && echo "> $lib_note" >> "$OUTPUT"
    
    echo "" >> "$OUTPUT"
    
    cat >> "$OUTPUT" <<'TABLE'
| Plik | Opis |
|------|------|
TABLE

    for file in "${SCRIPT_DIR}/lib"/*.sh; do
        [[ -f "$file" ]] || continue
        local basename
        basename=$(basename "$file")
        local desc
        desc=$(get_desc "lib/$basename")
        echo "| \`lib/$basename\` | ${desc:-Brak opisu} |" >> "$OUTPUT"
    done
    
    echo "" >> "$OUTPUT"
    
    # === DEV/ ===
    cat >> "$OUTPUT" <<'SECTION'
## üõ†Ô∏è dev/ - Narzƒôdzia deweloperskie

SECTION

    local dev_desc
    dev_desc=$(get_desc "dev/")
    [[ -n "$dev_desc" ]] && echo "> **$dev_desc**" >> "$OUTPUT"
    
    local dev_note
    dev_note=$(get_folder_note "dev")
    [[ -n "$dev_note" ]] && echo "> $dev_note" >> "$OUTPUT"
    
    echo "" >> "$OUTPUT"
    
    # dev/bin/
    cat >> "$OUTPUT" <<'SUBSECTION'
### dev/bin/ - Narzƒôdzia CLI

SUBSECTION

    local bin_desc
    bin_desc=$(get_desc "dev/bin/")
    [[ -n "$bin_desc" ]] && echo "> $bin_desc" >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    
    cat >> "$OUTPUT" <<'TABLE'
| Narzƒôdzie | Opis |
|-----------|------|
TABLE

    for file in "${SCRIPT_DIR}/dev/bin"/*; do
        [[ -f "$file" ]] || continue
        local basename
        basename=$(basename "$file")
        local desc
        desc=$(get_desc "dev/bin/$basename")
        local exe=""
        [[ -x "$file" ]] && exe=" ‚úÖ"
        echo "| \`$basename\`$exe | ${desc:-Brak opisu} |" >> "$OUTPUT"
    done
    
    echo "" >> "$OUTPUT"
    
    # dev/scripts/
    cat >> "$OUTPUT" <<'SUBSECTION'
### dev/scripts/ - Skrypty pomocnicze

SUBSECTION

    local scripts_desc
    scripts_desc=$(get_desc "dev/scripts/")
    [[ -n "$scripts_desc" ]] && echo "> $scripts_desc" >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    
    cat >> "$OUTPUT" <<'TABLE'
| Skrypt | Opis |
|--------|------|
TABLE

    for file in "${SCRIPT_DIR}/dev/scripts"/*.sh; do
        [[ -f "$file" ]] || continue
        local basename
        basename=$(basename "$file")
        local desc
        desc=$(get_desc "dev/scripts/$basename")
        echo "| \`$basename\` | ${desc:-Brak opisu} |" >> "$OUTPUT"
    done
    
    echo "" >> "$OUTPUT"
    
    # dev/cfg/
    cat >> "$OUTPUT" <<'SUBSECTION'
### dev/cfg/ - Konfiguracje

SUBSECTION

    local cfg_desc
    cfg_desc=$(get_desc "dev/cfg/")
    [[ -n "$cfg_desc" ]] && echo "> $cfg_desc" >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    
    cat >> "$OUTPUT" <<'TABLE'
| Plik | Opis |
|------|------|
TABLE

    for file in "${SCRIPT_DIR}/dev/cfg"/*; do
        [[ -f "$file" ]] || continue
        local basename
        basename=$(basename "$file")
        local desc
        desc=$(get_desc "dev/cfg/$basename")
        echo "| \`$basename\` | ${desc:-Brak opisu} |" >> "$OUTPUT"
    done
    
    echo "" >> "$OUTPUT"
    
    # dev/systemd/
    cat >> "$OUTPUT" <<'SUBSECTION'
### dev/systemd/ - Jednostki systemd

SUBSECTION

    local systemd_desc
    systemd_desc=$(get_desc "dev/systemd/")
    [[ -n "$systemd_desc" ]] && echo "> $systemd_desc" >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    
    cat >> "$OUTPUT" <<'TABLE'
| Jednostka | Opis |
|-----------|------|
TABLE

    for file in "${SCRIPT_DIR}/dev/systemd"/*; do
        [[ -f "$file" ]] || continue
        local basename
        basename=$(basename "$file")
        local desc
        desc=$(get_desc "dev/systemd/$basename")
        echo "| \`$basename\` | ${desc:-Brak opisu} |" >> "$OUTPUT"
    done
    
    echo "" >> "$OUTPUT"
    
    # dev/tests/
    cat >> "$OUTPUT" <<'SUBSECTION'
### dev/tests/ - Testy BATS

SUBSECTION

    local tests_desc
    tests_desc=$(get_desc "dev/tests/")
    [[ -n "$tests_desc" ]] && echo "> $tests_desc" >> "$OUTPUT"
    echo "" >> "$OUTPUT"
    
    cat >> "$OUTPUT" <<'TABLE'
| Test | Opis |
|------|------|
TABLE

    for file in "${SCRIPT_DIR}/dev/tests"/*.bats; do
        [[ -f "$file" ]] || continue
        local basename
        basename=$(basename "$file")
        local desc
        desc=$(get_desc "dev/tests/$basename")
        echo "| \`$basename\` | ${desc:-Brak opisu} |" >> "$OUTPUT"
    done
    
    echo "" >> "$OUTPUT"
    
    # === DOCS/ ===
    cat >> "$OUTPUT" <<'SECTION'
## üìö docs/ - Dokumentacja

SECTION

    local docs_desc
    docs_desc=$(get_desc "docs/")
    [[ -n "$docs_desc" ]] && echo "> **$docs_desc**" >> "$OUTPUT"
    
    local docs_note
    docs_note=$(get_folder_note "docs")
    [[ -n "$docs_note" ]] && echo "> $docs_note" >> "$OUTPUT"
    
    echo "" >> "$OUTPUT"
    
    cat >> "$OUTPUT" <<'TABLE'
| Dokument | Opis |
|----------|------|
TABLE

    for file in "${SCRIPT_DIR}/docs"/*.md; do
        [[ -f "$file" ]] || continue
        local basename
        basename=$(basename "$file")
        local desc
        desc=$(get_desc "docs/$basename")
        echo "| \`$basename\` | ${desc:-Brak opisu} |" >> "$OUTPUT"
    done
    
    echo "" >> "$OUTPUT"
    
    # === FOOTER ===
    cat >> "$OUTPUT" <<'FOOTER'
---

## üîÑ Aktualizacja

Aby zaktualizowaƒá ten indeks:

```bash
./dev/bin/eww-index
# lub
make index
```

**Wygenerowano:** `./dev/bin/eww-index`  
**≈πr√≥d≈Ço opis√≥w:** `.filedesc`
FOOTER

    echo -e "${GREEN}[OK]${NC} Wygenerowano: $OUTPUT"
}

# Main
main() {
    cd "$SCRIPT_DIR" || exit 1
    
    load_descriptions
    generate_index
    
    echo -e "${BLUE}[INFO]${NC} PodglƒÖd: glow INDEX.md"
}

main "$@"
