#!/usr/bin/env bash
set -Eeuo pipefail
cd "$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")"/.. && pwd)"

# Auto-commit helper for systemd timer.
# By default this script will skip git hooks to avoid failing the automated run
# when a pre-commit hook would return non-zero (which previously caused exit 128).
# You can override and force verification with --verify.
VERIFY=0
while [[ $# -gt 0 ]]; do
	case "$1" in
		--verify) VERIFY=1; shift ;;
		--no-verify) VERIFY=0; shift ;;
		-h|--help)
			cat <<EOF
Usage: $(basename "$0") [--verify|--no-verify]

By default the script runs with --no-verify (skip hooks). Use --verify to run hooks.
EOF
			exit 0
			;;
		*) break ;;
	esac
done

MSG="auto: snapshot $(date -u +%F_%H%M%SZ)"
git add -A
if [[ $VERIFY -eq 1 ]]; then
	git commit -m "$MSG" || true
else
	# Skip hooks for automated snapshots to avoid failing the systemd job on hook errors
	git commit --no-verify -m "$MSG" || true
fi

