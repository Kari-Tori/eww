#!/usr/bin/env bash
# /git/eww/init-eww.sh — EWW header (v3, quote-safe, tty-safe)

: "${EWW_HEADER:=1}"
: "${EWW_HEADER_TITLE:=E-Waste Workshop}"
: "${EWW_HEADER_TAGLINE:=Miłego dnia}"
: "${EWW_HEADER_BORDER:=1}"

EWW_HEADER_DATE_FMT="${EWW_HEADER_DATE_FMT:-+%d:%m:%Y %H:%M}"
EWW_HEADER_CFG_PATH="${EWW_HEADER_CFG_PATH:-/git/eww/init-eww.sh}"

# kolory opcjonalne
if [[ -t 1 ]] && command -v tput >/dev/null 2>&1; then _B="$(tput bold)"; _0="$(tput sgr0)"; else _B=""; _0=""; fi

# —— sanitacja formatu daty ——
eww_fmt(){
  local f="${EWW_HEADER_DATE_FMT}"
  f="${f//\"/}"          # usuń "
  f="${f//\'/}"          # usuń '
  [[ ${f:0:1} == '+' ]] || f="+%d:%m:%Y %H:%M"
  printf '%s' "$f"
}

# —— funkcje ——
eww_now(){ local f; f="$(eww_fmt)"; LC_ALL=C date "$f" 2>/dev/null || LC_ALL=C date '+%d:%m:%Y %H:%M'; }
eww_uptime(){ local s d h m; s=$(cut -d. -f1 /proc/uptime 2>/dev/null || echo 0); (( d=s/86400, s%=86400, h=s/3600, s%=3600, m=s/60 )); (( d>0 ))&&printf '%dd %dh %dm' "$d" "$h" "$m"||(( h>0 ))&&printf '%dh %dm' "$h" "$m"||printf '%dm' "$m"; }
eww_load(){ read -r l1 l5 l15 _ < /proc/loadavg 2>/dev/null || { l1=.; l5=.; l15=.; }; printf '%s %s %s' "$l1" "$l5" "$l15"; }
eww_mem(){ awk '$1=="MemTotal:"{t=$2} $1=="MemAvailable:"{a=$2} END{ if(t>0){used=(t-a)/1024; total=t/1024; printf "%d/%dMiB", used, total} else{print "n/a"} }' /proc/meminfo 2>/dev/null; }
eww_home_free(){ df -h "$HOME" 2>/dev/null | awk 'NR==2{print $4}'; }
eww_tty(){ if [[ -t 1 ]]; then local t; t="$(/usr/bin/tty 2>/dev/null)"; t="${t##*/}"; echo "${t#pts/}"; else echo "?"; fi; }
eww_cfg_status(){ local p s; p=$(readlink -f -- "$EWW_HEADER_CFG_PATH" 2>/dev/null || echo "$EWW_HEADER_CFG_PATH"); [[ -r "$EWW_HEADER_CFG_PATH" ]] && s='[OK]' || s='[MISSING]'; printf '%s %s' "$p" "$s"; }

eww_header(){
  [[ "${EWW_HEADER}" -eq 0 ]] && return 0
  local now up load mem home tty bashv cfg
  now="$(eww_now)"; up="$(eww_uptime)"; load="$(eww_load)"; mem="$(eww_mem)"; home="$(eww_home_free)"; tty="$(eww_tty)"
  bashv="${BASH_VERSION%%(*}"; cfg="$(eww_cfg_status)"
  local L1=" ${USER}@${HOSTNAME:-$(hostname)} • ${now}"
  local L2=" up:${up} • load:${load} • mem:${mem} • home:${home}"
  local L3=" ${EWW_HEADER_TITLE} • bash:${bashv} • tty:${tty} • cfg:${cfg}"

  printf '\n'
  if [[ "${EWW_HEADER_BORDER}" -eq 1 ]]; then
    printf '╭─%s%s%s\n' "${_B}" "$L1" "${_0}"
    printf '├─ %s\n'     "$L2"
    printf '╰─ %s • %s\n\n' "$L3" "${EWW_HEADER_TAGLINE}"
  else
    printf '%s%s%s\n' "${_B}" "$L1" "${_0}"
    printf '%s\n'     "$L2"
    printf '%s • %s\n\n' "$L3" "${EWW_HEADER_TAGLINE}"
  fi
}
return 0 2>/dev/null || true
