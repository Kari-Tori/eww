SHELL := bash
.SHELLFLAGS := -eu -o pipefail -c
.DEFAULT_GOAL := help

# --- Konfiguracja g≈Ç√≥wna ----------------------------------------------------
TODO_FILE := usr/jakubc/todo.md
TODO_SSH_FILE := usr/jakubc/TODO-SSH.md
SSH_HOST := karinam@192.168.0.77
REMOTE_REPO := /usr/karinam/git/eww
LOCAL_REPO := /jakubc/git/eww
LEGACY_REPO := /git/eww
BACKUP_ROOT := /jakubc/git
LOCAL_GIT_ROOT := /git/eww
CONFIG_CODE := $(HOME)/.config/Code
CONFIG_OBSIDIAN := $(HOME)/.config/obsidian
CONFIG_VSCODE := $(HOME)/.vscode

# --- Helpers -----------------------------------------------------------------
.PHONY: help todo todo-paczki todo-obiad todo-ebay todo-posciel todo-ssh \
	backup-gerc prepare-target ssh-remote-check ssh-remote-git ssh-remote-config \
	sync-dry sync-run sync-perms sync-configs diff-repos sync-legacy-dry \
	sync-legacy set-alias git-verify project-check \
	install uninstall test test-bats lint clean \
	version bump-version changelog readme-check frontmatter frontmatter-dry \
	tag auto-tag git-status git-push obsidian-fix vscode-fix \
	doctor banner status commit

help: ## Wy≈õwietl dostƒôpne cele Makefile (plan dnia + operacje SSH + narzƒôdzia eww)
	@echo "E-Waste Workshop :: TODO + TODO-SSH"
	@echo ""
	@awk 'BEGIN {FS = ":.*##"; printf "Dostƒôpne cele:\n\n"} \
		/^[a-zA-Z0-9_.-]+:.*##/ {printf "  %-22s %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "Przyk≈Çad: make sync-run"

# --- Plan dnia (usr/jakubc/todo.md) -----------------------------------------
todo: ## PodglƒÖd pe≈Çnego planu dnia z usr/jakubc/todo.md
	@if command -v glow >/dev/null 2>&1; then \
		glow $(TODO_FILE); \
	elif command -v bat >/dev/null 2>&1; then \
		bat $(TODO_FILE); \
	else \
		cat $(TODO_FILE); \
	fi

todo-paczki: ## Instrukcja pakowania i wysy≈Çki (GTX1060 + trzy GTR1660)
	@printf "%s\n" \
		"üì¶ Wysy≈Çka paczek (zob. usr/jakubc/todo.md)" \
		"1. Paczka #1 ‚Äì karta GTX1060." \
		"2. Paczka #2 ‚Äì trzy karty GTR1660." \
		"3. Paczka #3 ‚Äì kup nowƒÖ etykietƒô ‚â§ 10 ¬£ (najta≈Ñsza opcja)." \
		"4. Zdjƒôcia etykiet i opisy sƒÖ na WhatsAppie." \
		"5. Pokazujesz kod paczki -> pani drukuje etykietƒô -> naklejasz." \
		"6. Odbierz potwierdzenia nadania i schowaj." \
		"7. Dostarcz paczki przed zamkniƒôciem okienek."

todo-obiad: ## Instrukcja podgrzania obiadu
	@printf "%s\n" \
		"üçó Obiad z lod√≥wki:" \
		"- Na pierwszej p√≥≈Çce znajdziesz piersi z kurczaka i ziemniaki." \
		"- Podgrzej w piekarniku ~180¬∞C przez ok. 20 minut." \
		"- Dorzuƒá sur√≥wkƒô stojƒÖcƒÖ obok."

todo-ebay: ## Przypomnienie o kliencie eBay les.sara61
	@printf "%s\n" \
		"üíå Klientka eBay: les.sara61" \
		"- Napisz jej dzisiaj wiadomo≈õƒá, ≈ºeby mia≈Ça spokojnƒÖ g≈Çowƒô." \
		"- Potwierd≈∫ status wysy≈Çki w spokojnym tonie."

todo-posciel: ## Zadanie z po≈õcielƒÖ przed powrotem Kariny
	@printf "%s\n" \
		"üõèÔ∏è Po≈õciel:" \
		"- Przed powrotem Kariny zdejmij aktualnƒÖ po≈õciel." \
		"- Nowy komplet czeka ‚Äì Karina za≈Ço≈ºy go po przyj≈õciu."

todo-ssh: ## PodglƒÖd szczeg√≥≈Çowego planu migracji SSH (usr/jakubc/TODO-SSH.md)
	@if command -v glow >/dev/null 2>&1; then \
		glow $(TODO_SSH_FILE); \
	elif command -v bat >/dev/null 2>&1; then \
		bat $(TODO_SSH_FILE); \
	else \
		cat $(TODO_SSH_FILE); \
	fi

# --- Migracja repo (TODO-SSH) -----------------------------------------------
backup-gerc: ## Krok 1: backup /git/eww do /jakubc/git z timestampem
	@cd $(LOCAL_GIT_ROOT) && git status
	@sudo mkdir -p $(BACKUP_ROOT)
	@ts=$$(date +%Y%m%d_%H%M%S); \
		echo "üì¶ Tworzƒô backup do $(BACKUP_ROOT)/eww_backup_$$ts"; \
		sudo cp -a $(LOCAL_GIT_ROOT) "$(BACKUP_ROOT)/eww_backup_$$ts"

prepare-target: ## Krok 2: przygotuj /jakubc/git/eww i prawa
	@sudo mkdir -p $(LOCAL_REPO)
	@sudo chown -R $$USER:$$USER $(BACKUP_ROOT)
	@df -h /jakubc

ssh-remote-check: ## Krok 3: sprawd≈∫ ≈õcie≈ºki i miejsce na Asus_Z77
	@ssh $(SSH_HOST) 'cd $(REMOTE_REPO) && hostname && pwd && df -h .'

ssh-remote-git: ## Krok 4: status Gita i ostatnie commity na Asus_Z77
	@ssh $(SSH_HOST) 'cd $(REMOTE_REPO) && git status -sb && git log --oneline -15 && git log --since="2025-10-15" --stat'

ssh-remote-config: ## Krok 5: zrzut konfiguracji VS Code/Obsidian na Asus_Z77
	@ssh $(SSH_HOST) 'tree -L 2 ~/.config/Code > ~/code_config_tree.txt && tree -L 2 ~/.config/obsidian > ~/obsidian_config_tree.txt && ls -la ~/.vscode'

sync-dry: ## Krok 6: rsync dry-run Asus_Z77 -> /jakubc/git/eww
	@rsync -avh --dry-run --progress $(SSH_HOST):$(REMOTE_REPO)/. $(LOCAL_REPO)/

sync-run: ## Krok 6: rsync w≈Ça≈õciwy Asus_Z77 -> /jakubc/git/eww
	@rsync -avh --progress $(SSH_HOST):$(REMOTE_REPO)/. $(LOCAL_REPO)/

sync-perms: ## Krok 7: napraw uprawnienia w /jakubc/git/eww
	@sudo chown -R $$USER:$$USER $(LOCAL_REPO)
	@find $(LOCAL_REPO) -type d -exec chmod 755 {} \;
	@find $(LOCAL_REPO) -type f -exec chmod 644 {} \;

sync-configs: ## Krok 8: backup i rsync konfiguracji Code/Obsidian/VSCode
	@mkdir -p $(CONFIG_CODE)_backup $(CONFIG_OBSIDIAN)_backup $(CONFIG_VSCODE)_backup
	@cp -a $(CONFIG_CODE)/. $(CONFIG_CODE)_backup/ || true
	@cp -a $(CONFIG_OBSIDIAN)/. $(CONFIG_OBSIDIAN)_backup/ || true
	@cp -a $(CONFIG_VSCODE)/. $(CONFIG_VSCODE)_backup/ || true
	@rsync -avh --progress $(SSH_HOST):~/.config/Code/ $(CONFIG_CODE)/
	@rsync -avh --progress $(SSH_HOST):~/.vscode/ $(CONFIG_VSCODE)/
	@rsync -avh --progress $(SSH_HOST):~/.config/obsidian/ $(CONFIG_OBSIDIAN)/

diff-repos: ## Krok 9: por√≥wnaj /git/eww vs /jakubc/git/eww
	@ts=$$(date +%Y%m%d_%H%M); \
		diff -qr $(LEGACY_REPO) $(LOCAL_REPO) | tee $(BACKUP_ROOT)/diff_eww_$$ts.log

sync-legacy-dry: ## Krok 10: dry-run rsync z /git/eww -> /jakubc/git/eww
	@rsync -avh --dry-run --progress $(LEGACY_REPO)/ $(LOCAL_REPO)/

sync-legacy: ## Krok 10: rsync brakujƒÖcych plik√≥w z /git/eww -> /jakubc/git/eww
	@rsync -avh --progress $(LEGACY_REPO)/ $(LOCAL_REPO)/

set-alias: ## Krok 11: dodaj alias proj i otw√≥rz repo w VS Code
	@grep -qxF 'alias proj="cd $(LOCAL_REPO)"' ~/.bashrc || \
		echo 'alias proj="cd $(LOCAL_REPO)"' >> ~/.bashrc
	@. ~/.bashrc
	@if command -v code >/dev/null 2>&1; then \
		code $(LOCAL_REPO); \
	else \
		echo "VS Code niedostƒôpny ‚Äì pomi≈Ñ rƒôcznie"; \
	fi

git-verify: ## Krok 12: sprawd≈∫ status/log w nowym repo
	@cd $(LOCAL_REPO) && git status
	@cd $(LOCAL_REPO) && git log --graph --oneline -10

project-check: ## Krok 13: npm install + lint/test/dev w nowym repo
	@cd $(LOCAL_REPO) && npm install
	@cd $(LOCAL_REPO) && npm run lint && npm test
	@cd $(LOCAL_REPO) && npm run dev

# ============================================================================
# Podstawowe operacje eww
# ============================================================================

.PHONY: install uninstall test test-bats lint clean

install: ## Instaluj pomocnicze binaria do PREFIX (domy≈õlnie ~/bin)
	@echo "üì¶ Instalacja eww..."
	@PREFIX=${PREFIX:-~/bin} && \
		mkdir -p "$$PREFIX" && \
		cp -v bin/eww-* "$$PREFIX/" && \
		chmod +x "$$PREFIX"/eww-* && \
		echo "‚úÖ Zainstalowano do $$PREFIX"

uninstall: ## Usu≈Ñ zainstalowane binaria eww-*
	@echo "üóëÔ∏è  Odinstalowanie eww..."
	@PREFIX=${PREFIX:-~/bin} && \
		rm -vf "$$PREFIX"/eww-* && \
		echo "‚úÖ Odinstalowano z $$PREFIX"

test: test-bats ## Uruchom testy Bats

test-bats: ## Uruchom wszystkie testy z tests/
	@echo "üß™ Uruchamiam testy Bats..."
	@command -v bats >/dev/null || (echo "‚ùå Bats nie zainstalowany: sudo apt install bats" && exit 1)
	@bats tests/

lint: ## Sprawd≈∫ kod shellcheck
	@echo "üîç ShellCheck..."
	@command -v shellcheck >/dev/null || (echo "‚ùå ShellCheck nie zainstalowany: sudo apt install shellcheck" && exit 1)
	@find bin lib scripts -type f \( -name "*.sh" -o ! -name "*.*" \) -exec shellcheck {} \; 2>&1 | head -50

clean: ## Usu≈Ñ pliki tymczasowe (*.bak, *.tmp)
	@echo "üßπ Czyszczenie..."
	@find . -type f \( -name "*.bak" -o -name "*.tmp" \) -delete
	@echo "‚úÖ Wyczyszczono"

# ============================================================================
# Wersjonowanie i changelog
# ============================================================================

.PHONY: version bump-version changelog

version: ## Wy≈õwietl aktualnƒÖ wersjƒô projektu
	@echo "üìå Wersja projektu:"
	@./scripts/version.sh 2>/dev/null || cat VERSION 2>/dev/null || echo "0.0.0"

bump-version: ## Zwiƒôksz wersjƒô (MAJOR, MINOR lub PATCH)
	@echo "üîº Zwiƒôkszanie wersji..."
	@./scripts/bump-version.sh $(BUMP)

changelog: ## Wygeneruj CHANGELOG.md na podstawie commit√≥w
	@echo "üìù Generowanie changelog..."
	@./scripts/generate-changelog.sh || echo "‚ùå Brak skryptu generate-changelog.sh"

# ============================================================================
# README i dokumentacja
# ============================================================================

.PHONY: readme-check

readme-check: ## Sprawd≈∫ sp√≥jno≈õƒá README, VERSION i notatek wydania
	@echo "üìÑ Sprawdzanie README..."
	@./scripts/check_readme.sh

# ============================================================================
# Frontmatter i tagging
# ============================================================================

.PHONY: frontmatter frontmatter-dry auto-tag

frontmatter: ## Wygeneruj/zaktualizuj frontmatter YAML we wszystkich plikach
	@echo "üè∑Ô∏è  Generowanie frontmatter..."
	@./scripts/eww-frontmatter.sh .

frontmatter-dry: ## PodglƒÖd frontmatter bez zapisywania (dry-run)
	@echo "üëÅÔ∏è  PodglƒÖd frontmatter (dry-run)..."
	@./scripts/eww-frontmatter.sh --dry-run . | head -100

auto-tag: ## Automatyczne tagowanie wszystkich plik√≥w
	@echo "üè∑Ô∏è  Automatyczne tagowanie..."
	@./scripts/eww-auto-tag.sh . || echo "‚ùå Brak skryptu eww-auto-tag.sh"

# ============================================================================
# Git operacje
# ============================================================================

.PHONY: tag git-status git-push commit

tag: ## Automatyczne tagowanie Git (eww-auto-tag.sh)
	@echo "üè∑Ô∏è  Tworzenie tagu Git..."
	@./scripts/eww-auto-tag.sh git-tag 2>/dev/null || echo "‚ùå U≈ºyj: git tag -a v1.0.0 -m 'Release 1.0.0'"

git-status: ## Status Git z podsumowaniem
	@echo "üìä Git status:"
	@git status -sb
	@echo ""
	@echo "Ostatnie 10 commit√≥w:"
	@git log --oneline -10

git-push: ## Push do origin z tagami
	@echo "‚¨ÜÔ∏è  Pushing to origin..."
	@git push origin $(shell git branch --show-current)
	@git push --tags

commit: ## Interaktywny commit z Conventional Commits
	@echo "üí¨ Commit..."
	@./bin/eww-commit 2>/dev/null || git commit

# ============================================================================
# Narzƒôdzia diagnostyczne i naprawcze
# ============================================================================

.PHONY: obsidian-fix vscode-fix doctor banner status

obsidian-fix: ## Napraw konfiguracjƒô Obsidian vault
	@echo "üîß Naprawianie Obsidian..."
	@./scripts/eww-obsidian-fix.sh --fix

vscode-fix: ## Wyczy≈õƒá cache VS Code (Service Worker errors)
	@echo "üîß Czyszczenie VS Code cache..."
	@./scripts/eww-vscode-fix.sh --all

doctor: ## Diagnostyka ≈õrodowiska (eww-doctor)
	@echo "ü©∫ Sprawdzanie ≈õrodowiska..."
	@./bin/eww-doctor 2>/dev/null || echo "‚ùå Brak bin/eww-doctor"

banner: ## Wy≈õwietl banner eww
	@./bin/eww-banner 2>/dev/null || echo "E-Waste Workshop"

status: ## Status projektu eww (Git + environment)
	@echo "üìä Status projektu E-Waste Workshop"
	@echo ""
	@./bin/eww-status 2>/dev/null || (echo "Git:" && git status -sb && echo "" && echo "Wersja:" && cat VERSION 2>/dev/null)

# ============================================================================
# GitHub & AI Tools
# ============================================================================

.PHONY: github-setup github-auth github-status

github-setup: ## Install GitHub CLI, Copilot, Continue.dev
	@echo "üöÄ Installing GitHub & AI tools..."
	@./bin/eww-github-setup

github-auth: ## Authenticate with GitHub CLI
	@echo "üîê Authenticating with GitHub..."
	@gh auth login

github-status: ## Check GitHub tools status
	@echo "üìä GitHub Tools Status:"
	@echo ""
	@echo "GitHub CLI:"
	@command -v gh >/dev/null && gh --version || echo "  ‚ùå Not installed"
	@echo ""
	@echo "GitHub Auth:"
	@gh auth status 2>/dev/null || echo "  ‚ùå Not authenticated"
	@echo ""
	@echo "Copilot CLI:"
	@gh extension list 2>/dev/null | grep copilot || echo "  ‚ùå Not installed"
	@echo ""
	@echo "VS Code Extensions:"
	@command -v code >/dev/null && code --list-extensions | grep -E "(Continue|copilot)" || echo "  ‚ùå VS Code not found"

